name: Continuous Integration

on:
  pull_request:
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref_name != 'main' }}

jobs:
  wpt:
    name: Web Platform Test
    runs-on: ubuntu-latest
    steps:
      - name: Install Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.1.10
      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11
      - uses: actions/checkout@v4
      - name: Run
        run: |
          git clone https://github.com/denoland/deno.git --branch v2.1.10 --depth 1
          cd deno && git submodule init && git submodule update
          deno run -A --lock=tools/deno.lock.json --config tests/config/deno.json\
            ./tests/wpt/wpt.ts setup
          cd tests/wpt/suite/
          python3 ./wpt make-hosts-file | sudo tee -a /etc/hosts
          cd ../../../
          deno run -A --lock=tools/deno.lock.json --config tests/config/deno.json \
            ./tests/wpt/wpt.ts run --binary=$(which deno) --json ../bbb.json
          cd ../ && python3 run.py
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: out
          path: out.json
          retention-days: 5