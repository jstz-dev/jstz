name: Continuous Integration

on:
  pull_request:
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref_name != 'main' }}

jobs:
  wpt:
    name: Web Platform Test
    runs-on: ubuntu-latest
    steps:
      - name: Run
        run: |
          ln -s /usr/bin/python3.11 /usr/bin/python3
          wget https://github.com/denoland/deno/releases/download/v2.1.7/deno-x86_64-unknown-linux-gnu.zip && unzip deno-x86_64-unknown-linux-gnu.zip && mv deno /usr/bin/deno
          git clone https://github.com/denoland/deno.git --branch v2.1.7 --depth 1
          cd deno && git submodule init && git submodule update
          deno run -A --lock=tools/deno.lock.json --config tests/config/deno.json \
            ./tests/wpt/wpt.ts run --quiet --binary=$(which deno) --json bbb.json -- /WebCryptoAPI/wrapKey_unwrapKey/wrapKey_unwrapKey.https.any
